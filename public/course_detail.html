<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>!Graduated</title>
  <link rel="stylesheet" href="stylesheets/course_detail.css">
  <link rel="stylesheet" href="stylesheets/index.css" />

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="img/favicon.svg" type="image/svg+xml">
  <script src="javascripts/index.js"></script>
</head>

<body onload="init()">
  <!-- Navigation -->
  <!-- <nav class="navbar">
    <a href="/" class="logo">!Graduated</a>
    <a href="/signin" class="btn-login">Log In</a>
  </nav> -->

  <!-- App View (Logged In) -->
  <div id="app" class="app">

    <nav class="navbar">
      <a href="/" class="logo">!Graduated</a>
      <div class="tabs hidden" id="tabs">
        <button class="tab" onclick="goHome()">Home</button>
        <button class="tab" onclick="goSaved()">Saved</button>
        <button class="tab" onclick="goCourses()">Courses</button>
        <button class="tab" onclick="goProfile()">Profile</button>
      </div>
      <a href="/signin" id="login-btn" class="btn-login">Log In</a>
      <a href="/signout" id="logout-btn" class="btn-login hidden">Log Out</a>
    </nav>

    <div id="saved" class="page">
      <button class="back-btn" onclick="history.back()">← Back to All Courses</button>
      <div class="container">
        <h1 id="courseCode"></h1>
        <h2 id="courseNameLong"></h2>
        <div id="desc"></div>
        <br>
        <div id="misc"></div>
      </div>
      <br>
      <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h1> Reviews</h1>
          <button onclick="openReview()" style="background: none; border: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-plus-square" viewBox="0 0 16 16">
              <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
              <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
            </svg>
          </button>
        </div>

        <!-- <div style="display: flex; flex-direction: column;"> -->
        <div id="reviewForm" class="review-form hidden" style="margin-top: 24px; padding: 24px; border: 2px solid #4B2E83; border-radius: 16px; background-color: #f8f6fc; box-shadow: 0 8px 18px rgba(0, 0, 0, 0.06); max-width: 700px;  box-sizing: border-box;">
          <label for="reviewText" style="font-weight: 600; color: #4B2E83; margin-bottom: 8px; display: block;">Your Review</label>
          <textarea id="reviewText" class="styled-textarea" placeholder="Write your review..." rows="4" style="width: 100%; padding: 1rem; border: 1.5px solid #b4a7d6; border-radius: 12px; font-size: 1rem; font-family: 'Poppins', sans-serif; color: #2e2e2e; background-color: white; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.04); resize: vertical;"></textarea>
          <button onclick="submitReview()" class="styled-submit" style="margin-top: 12px; background-color: #4B2E83; color: white; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 12px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease;">Submit</button>
        </div>
        <!-- </div> -->
        

        <div id="reviews" class="results-list" style="margin-top: 24px;"></div>
      </div>
    </div>

    <script>
      // opens the review box
      async function openReview() {
        if (document.getElementById("reviewForm").classList.contains("hidden")) {
          const user = await fetch('api/v1/user/myIdentity')
          const userJson = await user.json()
          if (userJson.status == 'loggedout') {
            alert("Please log in to leave a review")
            return
          }
          document.getElementById("reviewForm").classList.remove("hidden")
        } else {
          document.getElementById("reviewForm").classList.add("hidden")
          return
        }
      }

      // TO DO:: handle empty/ add cancel button
      async function submitReview() {
        const review = document.getElementById("reviewText").value
        document.getElementById("reviewForm").classList.add("hidden")
        const params = new URLSearchParams(window.location.search)
        const courseId = params.get('course')
        await fetch('api/v1/course/review', {
          method: 'POST',
            body: JSON.stringify({courseId: courseId, review: review}),
            headers: {'Content-Type': 'application/json'
          }
        })

        await loadReviews(courseId)
      }

      async function loadReviews(courseId) {
        let data = await fetch(`api/v1/course/review?courseId=${courseId}`)
        let res = await data.json()

        console.log("this is the load Reviews result", res)

        document.getElementById('reviews').innerHTML = Array.isArray(res) && res.length > 0
        ? res.map(review =>
          `<div class="review-item" style="background-color: #ffffff; padding: 1rem 1.25rem; border-radius: 12px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08); max-width: 700px; width: 100%; margin-bottom: 1rem;">
              <p class="review-text" style="font-size: 1rem; font-weight: 500; color: #2f2f2f; margin: 0;">${review.comment}</p>
              <p class="review-author" style="font-size: 0.875rem; color: #666; margin-top: 0.4rem;">– ${review.user}</p>
          </div>`
        ).join("")
        : "<p style='color: #666;'>No reviews for this course yet</p>"
      }

      // on page load, check session for current coursecode, call coursedetails
      // endpoint to get course data, and fill in html with those fields
      async function init()  {
        console.log("in detail init")
        document.getElementById("courseNameLong").innerText = "Loading...";
        const params = new URLSearchParams(window.location.search)
        console.log(params)

        const data = await fetch(`/api/v1/course/search?${params.toString()}`)
        const res = await data.json()
        const courseInfo = res.course[0]
        console.log(courseInfo)

        document.getElementById("courseCode").innerText = courseInfo.courseId
        document.getElementById("courseNameLong").innerText = courseInfo.courseTitle
        document.getElementById("desc").innerText = courseInfo.description

        let areas = ""
        let potentialAreas = ["Diversity","EnglishComposition","IndividualsAndSocieties","NaturalWorld",
        "QuantitativeAndSymbolicReasoning", "VisualLiteraryAndPerformingArts", "Writing"]
        console.log(potentialAreas)

        let newAreas = {
          "VisualLiteraryAndPerformingArts":"A&H",
          "IndividualsAndSocieties":"SSc",
          "NaturalWorld":"NSc",
          "QuantitativeAndSymbolicReasoning":"RSN",
          "Diversity": "Diversity",
          "EnglishComposition":"English Composition",
          "Writing":"Writing"
        }

        courseInfo.genEdReqs.forEach(element => {
          areas += newAreas[element] + ", "
        });

        areas = areas.slice(0, areas.length - 2)
        console.log(areas)

        console.log(courseInfo.credits)

        const miscString = areas
        ? `${courseInfo.credits} Credits | ${areas} | Avg. Rating: N/A`
        : `${courseInfo.credits} Credits | Avg. Rating: N/a`
        document.getElementById("misc").innerHTML = `<b> ${miscString} </b>`

        await loadReviews(courseInfo.courseId)
      }

      function avg(arr) {
        if (arr.length == 0) {
          return "N/A"
        }
        let sum = 0
        let i = 0
        while(i < arr.length) {
          sum += arr[i]
          i++
        }
        return ((sum * 1.0) / (i * 1.0))
      }
    </script>
</body>
</html>